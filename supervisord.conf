[supervisord]
logfile=/dev/null
logfile_maxbytes=0
loglevel=error
nodaemon=true
pidfile=/var/run/supervisord.pid
user=root

# ── 1. PostgreSQL ─────────────────────────────────────────────────────────────
[program:postgres]
command=/usr/lib/postgresql/15/bin/postgres -D /var/lib/postgresql/15/main -c config_file=/etc/postgresql/15/main/postgresql.conf
user=postgres
autostart=true
autorestart=true
priority=10
stdout_logfile=/var/log/supervisor/postgres.log
stderr_logfile=/var/log/supervisor/postgres.log

# ── 2. QuantReplay marketsimulator ───────────────────────────────────────────
# Waits for PostgreSQL to be up before starting.
[program:quantreplay]
command=/bin/bash -c "until pg_isready -h localhost -U postgres -d simdb > /dev/null 2>&1; do sleep 1; done && cd /market-simulator/quod && INSTANCE_ID=XETRA PREFIX=QUOD LOG_DIR=/market-simulator/quod/data/log /entrypoint_os.sh"
autostart=true
autorestart=true
priority=20
stdout_logfile=/var/log/supervisor/quantreplay.log
stderr_logfile=/var/log/supervisor/quantreplay.log

# ── 3. HUD MCP server ─────────────────────────────────────────────────────────
# Waits for QuantReplay REST health check before starting.
[program:mcp_server]
command=/bin/bash -c "until curl -sf http://localhost:9050/api/venuestatus > /dev/null 2>&1; do echo 'Waiting for QuantReplay...' >&2 && sleep 2; done && echo 'QuantReplay ready. Starting MCP server.' >&2 && cd /mcp_server && hud dev env:env --stdio"
autostart=true
autorestart=true
priority=30
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
